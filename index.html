<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سحب بضاعة من المستودع</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: #f4f4f4;
            margin: 0;
            padding: 15px;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #fff;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        h1 { margin: 0; font-size: 24px; color: #343a40; text-align: right; }
        .date-container { display: flex; align-items: center; }
        .date-container label { margin-left: 10px; font-weight: bold; color: #495057; }
        #date { border: 1px solid #ced4da; padding: 8px; border-radius: 4px; }

        #data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #data-table th, #data-table td { border: 1px solid #dee2e6; padding: 10px; text-align: right; vertical-align: middle; }
        #data-table th { background-color: #f8f9fa; font-weight: bold; color: #495057; }

        .input-container { position: relative; display: flex; align-items: center; }
        #data-table input { width: 100%; border: none; padding: 8px; box-sizing: border-box; background-color: transparent; font-family: 'Cairo', sans-serif; font-size: 15px; }
        #data-table input:focus { outline: 2px solid #80bdff; border-radius: 3px; }

        .scan-btn {
            position: absolute;
            left: 8px; top: 50%;
            transform: translateY(-50%);
            display: none; cursor: pointer;
            background-color: #007bff; color: white;
            border: none; border-radius: 4px;
            padding: 3px 9px; font-size: 12px;
        }
        .input-container:focus-within .scan-btn { display: block; }

        .footer { display: flex; justify-content: space-around; margin-top: 50px; font-weight: bold; color: #495057; padding: 0 20px; }
        .signature-field { text-align: center; }

        .buttons-container { text-align: center; margin-top: 40px; padding-top: 25px; border-top: 1px solid #e9ecef; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 25px; font-size: 16px; font-family: 'Cairo', sans-serif; border-radius: 5px; cursor: pointer; margin: 8px; }
        button#clear-btn { background-color: #dc3545; }
        button:hover { opacity: 0.85; }

        /* Scanner Modal Styles */
        #scanner-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 1000;
            justify-content: center; align-items: center;
        }
        #scanner-modal.is-visible { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #video { width: 100%; border-radius: 4px; }
        #close-scanner-btn { background-color: #6c757d; margin-top: 15px; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .container { box-shadow: none; border-radius: 0; max-width: 100%; margin: 0; }
            .buttons-container, .scan-btn, #scanner-modal { display: none !important; }
            tr.is-empty { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>سحب بضاعة من المستودع</h1>
            <div class="date-container">
                <label for="date">التاريخ:</label>
                <input type="date" id="date">
            </div>
        </div>

        <table id="data-table">
            <thead>
                <tr>
                    <th style="width: 20%;">الكمية</th>
                    <th>اسم المنتج</th>
                    <th style="width: 35%;">الباركود</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>

        <div class="footer">
            <div class="signature-field">
                <label>المستلم:</label>
                <span>...................................</span>
            </div>
            <div class="signature-field">
                <label>التوقيع:</label>
                <span>...................................</span>
            </div>
        </div>

        <div class="buttons-container">
            <button id="print-btn">طباعة / حفظ كـ PDF</button>
            <button id="clear-btn">مسح جميع البيانات</button>
        </div>
    </div>

    <div id="scanner-modal">
        <div class="modal-content">
            <p>Point camera at the barcode</p>
            <video id="video" playsinline></video>
            <button id="close-scanner-btn">Close</button>
        </div>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/zxing.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements ---
            const tableBody = document.getElementById('table-body');
            const dateInput = document.getElementById('date');
            const printBtn = document.getElementById('print-btn');
            const clearBtn = document.getElementById('clear-btn');
            const scannerModal = document.getElementById('scanner-modal');
            const videoElement = document.getElementById('video');
            const closeScannerBtn = document.getElementById('close-scanner-btn');
            
            // --- Scanner variables ---
            let codeReader = null;
            let selectedInput = null;

            // --- Functions ---
            function createRow(rowData = ['', '', '']) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="input-cell" value="${rowData[0]}"></td>
                    <td><input type="text" class="input-cell" value="${rowData[1]}"></td>
                    <td>
                        <div class="input-container">
                            <input type="text" class="input-cell barcode-input" value="${rowData[2]}">
                            <button class="scan-btn">Scan</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            }

            function checkAndAddRow() {
                const lastRow = tableBody.querySelector('tr:last-child');
                if (!lastRow) return;

                const inputs = lastRow.querySelectorAll('input');
                const isLastRowFilled = [...inputs].some(input => input.value.trim() !== '');

                if (isLastRowFilled) {
                    createRow();
                }
            }

            function saveData() {
                try {
                    const data = { date: dateInput.value, table: [] };
                    tableBody.querySelectorAll('tr').forEach(row => {
                        const rowData = [...row.querySelectorAll('.input-cell')].map(input => input.value);
                        if (rowData.some(cell => cell.trim() !== '')) {
                            data.table.push(rowData);
                        }
                    });
                    localStorage.setItem('sheetData', JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving data:", e);
                }
                updateEmptyRowClasses();
            }

            function loadData() {
                tableBody.innerHTML = '';
                let savedData = null;
                try {
                    savedData = JSON.parse(localStorage.getItem('sheetData'));
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                }
                
                dateInput.value = savedData?.date || new Date().toISOString().split('T')[0];

                if (savedData && Array.isArray(savedData.table)) {
                    savedData.table.forEach(rowData => createRow(rowData));
                }

                while (tableBody.rows.length < 2) {
                    createRow();
                }
                checkAndAddRow();
                updateEmptyRowClasses();
            }
            
            function updateEmptyRowClasses() {
                tableBody.querySelectorAll('tr').forEach(row => {
                    const isEmpty = ![...row.querySelectorAll('input')].some(input => input.value.trim() !== '');
                    row.classList.toggle('is-empty', isEmpty);
                });
            }

            function startScanner(event) {
                if (!event.target.classList.contains('scan-btn')) return;

                if (typeof ZXing === 'undefined') {
                    alert('Scanner feature could not be loaded. Please check your internet connection.');
                    return;
                }

                if (!codeReader) {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                }
                
                selectedInput = event.target.closest('.input-container').querySelector('input');
                scannerModal.classList.add('is-visible');

                codeReader.decodeFromVideoDevice(undefined, 'video', (result, err) => {
                    if (result) {
                        selectedInput.value = result.text;
                        stopScanner();
                        tableBody.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }).catch(err => {
                    console.error("Scanner Error:", err);
                    alert('Could not start camera. Please make sure you have granted camera permission in your browser settings.');
                    stopScanner();
                });
            }

            function stopScanner() {
                if (codeReader) {
                    codeReader.reset();
                }
                scannerModal.classList.remove('is-visible');
            }

            // --- Event Listeners ---
            printBtn.addEventListener('click', () => window.print());
            clearBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to erase all data?')) {
                    localStorage.removeItem('sheetData');
                    loadData();
                }
            });

            closeScannerBtn.addEventListener('click', stopScanner);
            tableBody.addEventListener('click', startScanner);
            tableBody.addEventListener('input', () => {
                saveData();
                checkAndAddRow();
            });
            dateInput.addEventListener('change', saveData);

            // --- Initial Setup ---
            loadData();
        });
    </script>
</body>
</html>
